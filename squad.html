<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø©</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase.js"></script>

<style>
body{
  margin:0;
  background:#0b0f1a;
  font-family:Arial;
  color:white;
}
.top{
  background:#12172a;
  padding:15px;
  display:flex;
  justify-content:space-between;
}
.container{padding:20px;}

#formationSelect,#searchInput{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:none;
  outline:none;
}

.search-actions{
  display:flex;
  gap:10px;
}

.search-actions button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

.search-btn{background:#1b9c85;color:white;}
.reset-btn{background:#444;color:white;}

/* === Categories === */
.category{margin-bottom:15px;}

.category-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#12172a;
  padding:10px;
  border-radius:8px;
  cursor:pointer;
}

.category-content{
  margin-top:10px;
}

/* === Players === */
.players-list{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.player-card{
  background:#12172a;
  padding:10px;
  border-radius:10px;
  width:110px;
  text-align:center;
  cursor:pointer;
}

.player-card img{width:60px;}
.favorite{font-size:18px;}

/* === Field === */
.field{
  margin-top:20px;
  background:#1b2140;
  padding:20px;
  border-radius:12px;
  display:grid;
  grid-template-rows:1fr 2fr 2fr 2fr 1fr;
  gap:10px;
}
.row{
  display:flex;
  justify-content:center;
  gap:10px;
}
.field-slot{
  width:60px;
  height:60px;
  border:2px dashed #555;
  background:#12172a;
  display:flex;
  justify-content:center;
  align-items:center;
}
.field-slot img{width:50px;}
.slot-label{font-size:11px;}
</style>
</head>

<body>

<div class="top">
  <div onclick="goHome()" style="cursor:pointer">â¬… Ø±Ø¬ÙˆØ¹</div>
  <div>Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø©</div>
</div>

<div class="container">

<label>Ø§Ø®ØªØ± Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø©</label>
<select id="formationSelect" onchange="changeFormation()">
  <option value="4-4-2">4-4-2</option>
  <option value="4-3-3">4-3-3</option>
  <option value="3-5-2">3-5-2</option>
</select>

<!-- ğŸ” SEARCH -->
<input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">

<div class="search-actions">
  <button class="search-btn" onclick="confirmSearch()">ğŸ” ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø­Ø«</button>
  <button class="reset-btn" onclick="resetSearch()">â†©ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button>
</div>

<!-- â­ FAVORITES -->
<div class="category">
  <div class="category-header" onclick="toggleCategory('favList',this)">
    <span>â­ Ø§Ù„Ù…ÙØ¶Ù„ÙŠÙ†</span>
    <span>â¬‡ï¸</span>
  </div>
  <div class="category-content players-list" id="favList"></div>
</div>

<!-- ğŸ‘¥ ALL PLAYERS -->
<div class="category">
  <div class="category-header" onclick="toggleCategory('allList',this)">
    <span>ğŸ‘¥ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</span>
    <span>â¬‡ï¸</span>
  </div>
  <div class="category-content players-list" id="allList"></div>
</div>

<h3>Ø§Ù„Ù…Ù„Ø¹Ø¨</h3>
<div class="field" id="field"></div>

</div>

<script>
firebase.auth().onAuthStateChanged(user=>{
if(!user) return location="index.html";

const userRef=firebase.database().ref("usersefoot/"+user.uid);
const field=document.getElementById("field");
const formationSelect=document.getElementById("formationSelect");

let playersData={},formation="4-4-2",formationSlots=[];
let currentSearch="";

const formations={
 "4-4-2":[1,4,4,2,1],
 "4-3-3":[1,4,3,3,1],
 "3-5-2":[1,3,5,2,1]
};

function toggleCategory(id,el){
 const box=document.getElementById(id);
 const arrow=el.querySelector("span:last-child");
 if(box.style.display==="none"){
  box.style.display="flex";
  arrow.innerText="â¬‡ï¸";
 }else{
  box.style.display="none";
  arrow.innerText="â¬†ï¸";
 }
}

function confirmSearch(){
 currentSearch=document.getElementById("searchInput").value.toLowerCase();
 renderPlayers();
}

function resetSearch(){
 currentSearch="";
 document.getElementById("searchInput").value="";
 renderPlayers();
}

function renderPlayers(){
 const favList=document.getElementById("favList");
 const allList=document.getElementById("allList");
 favList.innerHTML="";
 allList.innerHTML="";

 let arr=Object.entries(playersData).map(([id,p])=>({id,...p}));

 if(currentSearch){
  arr=arr.filter(p=>p.name.toLowerCase().includes(currentSearch));
 }

 arr.sort((a,b)=>(b.rating||0)-(a.rating||0));

 arr.forEach(p=>{
  const div=document.createElement("div");
  div.className="player-card";
  div.draggable=true;
  div.innerHTML=`
   <div class="favorite">${p.favorite?"â­":"â˜†"}</div>
   <img src="${p.img}">
   <div>${p.name}</div>
   <div>${p.position}</div>
   <div>${p.rating}</div>
  `;

  div.onclick=()=>userRef.child("players/"+p.id+"/favorite").set(!p.favorite);
  div.ondragstart=e=>e.dataTransfer.setData("text/plain",p.id);

  (p.favorite?favList:allList).appendChild(div);
 });
}

function drawFormation(saved=[]){
 field.innerHTML="";
 formationSlots=[];
 formations[formation].forEach(num=>{
  const row=document.createElement("div");
  row.className="row";
  for(let i=0;i<num;i++){
   const slot=document.createElement("div");
   slot.className="field-slot";
   slot.dataset.index=formationSlots.length;
   slot.ondragover=e=>e.preventDefault();
   slot.ondrop=dropPlayer;
   row.appendChild(slot);
   formationSlots.push({slot,player:saved[formationSlots.length]||null});
  }
  field.appendChild(row);
 });
 formationSlots.forEach(s=>{
  if(s.player){
   s.slot.innerHTML=`<img src="${s.player.img}">
   <div class="slot-label">${s.player.position}</div>`;
  }
 });
}

function dropPlayer(e){
 const id=e.dataTransfer.getData("text/plain");
 const idx=e.currentTarget.dataset.index;
 const p=playersData[id];

 formationSlots[idx].player=p;
 e.currentTarget.innerHTML=`<img src="${p.img}">
 <div class="slot-label">${p.position}</div>`;

 userRef.update({formationPlayers:formationSlots.map(s=>s.player||null)});
}

function changeFormation(){
 formation=formationSelect.value;
 drawFormation();
}

userRef.on("value",snap=>{
 const data=snap.val()||{};
 playersData=data.players||{};
 formation=data.formation||"4-4-2";
 formationSelect.value=formation;
 renderPlayers();
 drawFormation(data.formationPlayers||[]);
});

window.toggleCategory=toggleCategory;
window.confirmSearch=confirmSearch;
window.resetSearch=resetSearch;
window.changeFormation=changeFormation;
window.goHome=()=>location="home.html";

});
</script>

</body>
</html>
