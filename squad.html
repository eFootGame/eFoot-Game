<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø©</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase.js"></script>

<style>
body{margin:0; background:#0b0f1a; font-family:Arial; color:white;}
.top{background:#12172a; padding:15px; display:flex; justify-content:space-between;}
.container{padding:20px;}
#formationSelect,#searchInput{width:100%; padding:10px; margin:8px 0; border-radius:8px; border:none; outline:none;}
.search-actions{display:flex; gap:10px;}
.search-actions button{flex:1; padding:10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
.search-btn{background:#1b9c85;color:white;}
.reset-btn{background:#444;color:white;}
.category{margin-bottom:15px;}
.category-header{display:flex; justify-content:space-between; align-items:center; background:#12172a; padding:10px; border-radius:8px; cursor:pointer;}
.category-content{margin-top:10px;}
.players-list{display:flex; flex-wrap:wrap; gap:10px;}
.player-card{background:#12172a; padding:10px; border-radius:10px; width:110px; text-align:center; cursor:pointer;}
.player-card img{width:60px;}
.favorite{font-size:18px;}
.field{margin-top:20px; background:#1b2140; padding:20px; border-radius:12px; display:grid; grid-template-rows:1fr 2fr 2fr 2fr 1fr; gap:10px;}
.row{display:flex; justify-content:center; gap:10px;}
.field-slot{width:60px; height:60px; border:2px dashed #555; background:#12172a; display:flex; justify-content:center; align-items:center; transition: border-color 0.2s;}
.field-slot img{width:50px;}
.slot-label{font-size:11px;}
#playerModal,#confirmModal{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#12172a; padding:20px; border-radius:12px; box-shadow:0 0 15px #000; z-index:1000;}
#modalOverlay{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900;}
#playerModal button,#confirmModal button{width:100%; padding:10px; margin-bottom:10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;}
#favBtn{background:#1b9c85;color:white;}
#fieldBtn{background:#1b2140;color:white;}
#sellBtn{background:#e74c3c;color:white;}
#cancelBtn{background:#444;color:white;}
#confirmYes{background:#e74c3c;color:white;}
#confirmNo{background:#444;color:white;}
.player-card:hover{background:#1b2140;}
</style>
</head>
<body>

<div class="top">
  <div onclick="goHome()" style="cursor:pointer">â¬… Ø±Ø¬ÙˆØ¹</div>
  <div>Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø©</div>
</div>

<div class="container">

<label>Ø§Ø®ØªØ± Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø©</label>
<select id="formationSelect" onchange="changeFormation()">
  <option value="4-4-2">4-4-2</option>
  <option value="4-3-3">4-3-3</option>
  <option value="3-5-2">3-5-2</option>
</select>

<input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
<div class="search-actions">
  <button class="search-btn" onclick="confirmSearch()">ğŸ” ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø­Ø«</button>
  <button class="reset-btn" onclick="resetSearch()">â†©ï¸ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button>
</div>

<div class="category">
  <div class="category-header" onclick="toggleCategory('favList',this)">
    <span>â­ Ø§Ù„Ù…ÙØ¶Ù„ÙŠÙ†</span>
    <span>â¬‡ï¸</span>
  </div>
  <div class="category-content players-list" id="favList"></div>
</div>

<div class="category">
  <div class="category-header" onclick="toggleCategory('allList',this)">
    <span>ğŸ‘¥ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</span>
    <span>â¬‡ï¸</span>
  </div>
  <div class="category-content players-list" id="allList"></div>
</div>

<h3>Ø§Ù„Ù…Ù„Ø¹Ø¨</h3>
<div class="field" id="field"></div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
<div id="playerModal">
  <div id="modalName" style="margin-bottom:15px;font-weight:bold;text-align:center;"></div>
  <button id="favBtn">â­ Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„ÙŠÙ†</button>
  <button id="fieldBtn">âš½ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ø¹Ø¨</button>
  <button id="sellBtn">ğŸ’° Ø¨ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨</button>
  <button id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div id="confirmModal">
  <div id="confirmText" style="margin-bottom:15px;text-align:center;font-weight:bold;"></div>
  <button id="confirmYes">Ù†Ø¹Ù…</button>
  <button id="confirmNo">Ù„Ø§</button>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>

<script>
firebase.auth().onAuthStateChanged(user=>{
if(!user) return location="index.html";

const userRef = firebase.database().ref("usersefoot/"+user.uid);
const field = document.getElementById("field");
const formationSelect = document.getElementById("formationSelect");
let playersData={}, formation="4-4-2", formationSlots=[], currentSearch="", selectingSlotPlayer=null;

const formations={ "4-4-2":[1,4,4,2,1], "4-3-3":[1,4,3,3,1], "3-5-2":[1,3,5,2,1] };

function toggleCategory(id,el){
 const box=document.getElementById(id);
 const arrow=el.querySelector("span:last-child");
 if(box.style.display==="none"){box.style.display="flex"; arrow.innerText="â¬‡ï¸";}
 else{box.style.display="none"; arrow.innerText="â¬†ï¸";}
}

function confirmSearch(){ currentSearch=document.getElementById("searchInput").value.toLowerCase(); renderPlayers(); }
function resetSearch(){ currentSearch=""; document.getElementById("searchInput").value=""; renderPlayers(); }

function renderPlayers(){
 const favList=document.getElementById("favList"), allList=document.getElementById("allList");
 favList.innerHTML=""; allList.innerHTML="";
 let arr=Object.entries(playersData).map(([id,p])=>({id,...p}));
 if(currentSearch) arr=arr.filter(p=>p.name.toLowerCase().includes(currentSearch));
 arr.sort((a,b)=>(b.rating||0)-(a.rating||0));
 arr.forEach(p=>{
  const div=document.createElement("div");
  div.className="player-card"; div.draggable=true;
  div.innerHTML=`<div class="favorite">${p.favorite?"â­":"â˜†"}</div><img src="${p.img}"><div>${p.name}</div><div>${p.position}</div><div>${p.rating}</div>`;
  div.onclick=()=>openPlayerModal(p);
  div.ondragstart=e=>e.dataTransfer.setData("text/plain",p.id);
  (p.favorite?favList:allList).appendChild(div);
 });
}

function drawFormation(saved=[]){
 field.innerHTML=""; formationSlots=[];
 formations[formation].forEach(num=>{
  const row=document.createElement("div"); row.className="row";
  for(let i=0;i<num;i++){
   const slot=document.createElement("div"); slot.className="field-slot";
   slot.dataset.index=formationSlots.length;
   slot.ondragover=e=>e.preventDefault();
   slot.ondrop=dropPlayer;
   row.appendChild(slot);
   formationSlots.push({slot,player:saved[formationSlots.length]||null});
  }
  field.appendChild(row);
 });
 formationSlots.forEach(s=>{
  if(s.player){ s.slot.innerHTML=`<img src="${s.player.img}"><div class="slot-label">${s.player.position}</div>`; s.slot.onclick = () => openFieldPlayerModal(s); }
  else s.slot.onclick = null;
 });
}

function dropPlayer(e){
 const id=e.dataTransfer.getData("text/plain"), idx=e.currentTarget.dataset.index;
 const p=playersData[id];
 formationSlots[idx].player=p;
 e.currentTarget.innerHTML=`<img src="${p.img}"><div class="slot-label">${p.position}</div>`;
 userRef.update({formationPlayers:formationSlots.map(s=>s.player||null)});
}

function changeFormation(){ formation=formationSelect.value; drawFormation(); }

const modal=document.getElementById("playerModal");
const confirmModal=document.getElementById("confirmModal");
const overlay=document.getElementById("modalOverlay");
let selectedPlayer=null;

function openPlayerModal(player){
 selectedPlayer=player;
 document.getElementById("modalName").innerText=`${player.name} (${player.position})`;
 modal.style.display="block"; overlay.style.display="block";

 const favBtn=document.getElementById("favBtn");
 const fieldBtn=document.getElementById("fieldBtn");
 const sellBtn=document.getElementById("sellBtn");
 const cancelBtn=document.getElementById("cancelBtn");

 favBtn.style.display="block"; favBtn.innerText="â­ Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„ÙŠÙ†";
 fieldBtn.style.display="block"; fieldBtn.innerText="âš½ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ø¹Ø¨";
 sellBtn.style.display="block"; sellBtn.innerText="ğŸ’° Ø¨ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨";
 cancelBtn.style.display="block"; cancelBtn.innerText="Ø¥Ù„ØºØ§Ø¡";

 // Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„ÙŠÙ†
 favBtn.onclick = ()=>{
   const newFav=!selectedPlayer.favorite;
   userRef.child("players/"+selectedPlayer.id+"/favorite").set(newFav);
   selectedPlayer.favorite=newFav;
   renderPlayers(); closeModal();
 }

 // ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø£ÙŠ Ø®Ø§Ù†Ø© ÙØ§Ø±ØºØ©
 fieldBtn.onclick = ()=>{
   selectingSlotPlayer = selectedPlayer;
   closeModal();
   formationSlots.forEach(s=>{
     if(!s.player){
       s.slot.style.borderColor="#1b9c85";
       s.slot.style.cursor="pointer";
       s.slot.onclick=()=>placePlayerInSlot(s,selectingSlotPlayer);
     }
   });
 }

 // Ø¨ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨
 sellBtn.onclick = ()=>{ confirmSell(selectedPlayer); }

 cancelBtn.onclick = ()=>closeModal();
}

// Ø¯Ø§Ù„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
function placePlayerInSlot(slotObj, player){
 slotObj.player = player;
 slotObj.slot.innerHTML=`<img src="${player.img}"><div class="slot-label">${player.position}</div>`;
 formationSlots.forEach(s=>{
   s.slot.style.borderColor="#555";
   s.slot.style.cursor="default";
   if(s.player) s.slot.onclick=()=>openFieldPlayerModal(s);
   else s.slot.onclick=null;
 });
 selectingSlotPlayer = null;
 userRef.update({formationPlayers:formationSlots.map(s=>s.player||null)});
}

// Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹
function confirmSell(player){
 modal.style.display="none";
 confirmModal.style.display="block";
 overlay.style.display="block";
 document.getElementById("confirmText").innerText=`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ ${player.name}ØŸ`;

 document.getElementById("confirmYes").onclick = ()=>{
   let gp=Math.floor((player.rating||0)/2), coins=0;
   if(player.rating>=95) coins=50;
   userRef.child("gp").transaction(curr=>(curr||0)+gp);
   if(coins>0) userRef.child("coins").transaction(curr=>(curr||0)+coins);
   userRef.child("players/"+player.id).remove();
   renderPlayers(); closeModal(); confirmModal.style.display="none";
   alert(`ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${gp} GP${coins>0?` Ùˆ${coins} ÙƒÙˆÙŠÙ†Ø²`:''}`);
 }

 document.getElementById("confirmNo").onclick = ()=>{ confirmModal.style.display="none"; closeModal(); }
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ù„Ø¹Ø¨ (Ù†Ù‚Ù„/Ø­Ø°Ù)
function openFieldPlayerModal(slotObj){
 selectedPlayer=slotObj.player;
 document.getElementById("modalName").innerText=`${selectedPlayer.name} (${selectedPlayer.position})`;
 modal.style.display="block"; overlay.style.display="block";

 document.getElementById("favBtn").style.display="none";
 document.getElementById("fieldBtn").style.display="block";
 document.getElementById("fieldBtn").innerText="ğŸ”„ Ù†Ù‚Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨";
 document.getElementById("sellBtn").style.display="none";

 // Ø²Ø± Ø§Ù„Ù†Ù‚Ù„
 document.getElementById("fieldBtn").onclick = ()=>{
   closeModal();
   selectingSlotPlayer = selectedPlayer;
   formationSlots.forEach(s=>{
     s.slot.style.borderColor = !s.player ? "#1b9c85" : "#555";
     s.slot.style.cursor = !s.player ? "pointer" : "default";
     if(!s.player) s.slot.onclick = ()=>{
       s.player = selectingSlotPlayer;
       s.slot.innerHTML=`<img src="${selectingSlotPlayer.img}"><div class="slot-label">${selectingSlotPlayer.position}</div>`;
       // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
       slotObj.player=null;
       slotObj.slot.innerHTML='';
       formationSlots.forEach(sl=>{
         sl.slot.style.borderColor="#555";
         sl.slot.style.cursor="default";
         if(sl.player) sl.slot.onclick=()=>openFieldPlayerModal(sl);
         else sl.slot.onclick=null;
       });
       selectingSlotPlayer = null;
       userRef.update({formationPlayers:formationSlots.map(s=>s.player||null)});
     };
   });
 }

 // Ø²Ø± Ø§Ù„Ø­Ø°Ù
 const cancelBtn=document.getElementById("cancelBtn");
 cancelBtn.innerText="ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨";
 cancelBtn.onclick = ()=>{
   slotObj.player=null; slotObj.slot.innerHTML='';
   closeModal();
   drawFormation(formationSlots.map(s=>s.player));
   userRef.update({formationPlayers:formationSlots.map(s=>s.player||null)});
   cancelBtn.innerText="Ø¥Ù„ØºØ§Ø¡";
 }
}

function closeModal(){ modal.style.display="none"; overlay.style.display="none"; selectedPlayer=null; confirmModal.style.display="none"; }

userRef.on("value",snap=>{
 const data=snap.val()||{};
 playersData=data.players||{};
 formation=data.formation||"4-4-2";
 formationSelect.value=formation;
 renderPlayers();
 drawFormation(data.formationPlayers||[]);
});

window.toggleCategory=toggleCategory;
window.confirmSearch=confirmSearch;
window.resetSearch=resetSearch;
window.changeFormation=changeFormation;
window.goHome=()=>location="home.html";

});
</script>
</body>
</html>
